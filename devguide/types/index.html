<!DOCTYPE html><html lang="en">
    <head>
    
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="robots" content="noindex,nofollow">

        <title>Notes on types - PCOT Documentation</title>
    
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">
    <link rel="stylesheet" href="../../css/lightbox.min.css">
    <link rel="stylesheet" href="../../css/site.css">

    

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
    <script src="../../js/lightbox-plus-jquery.min.js"></script>
 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container ">
                <a class="navbar-brand" href="../..">PCOT Documentation</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Getting Started <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../gettingstarted/" class="dropdown-item">Overview</a>
</li>
                                    
<li>
    <a href="../../gettingstarted/installrun/" class="dropdown-item">Installing and running</a>
</li>
                                    
<li>
    <a href="../../gettingstarted/concepts/" class="dropdown-item">PCOT concepts</a>
</li>
                                    
<li>
    <a href="../../gettingstarted/tutorial/" class="dropdown-item">Tutorial</a>
</li>
                                    
<li>
    <a href="../../gettingstarted/inputs/" class="dropdown-item">Loading other image formats</a>
</li>
                                    
<li>
    <a href="../../gettingstarted/help/" class="dropdown-item">Getting help</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">User Guide <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../userguide/" class="dropdown-item">Overview</a>
</li>
                                    
<li>
    <a href="../../userguide/principles/" class="dropdown-item">Operating principles</a>
</li>
                                    
<li>
    <a href="../../userguide/canvas/" class="dropdown-item">The Canvas</a>
</li>
                                    
<li>
    <a href="../../userguide/globalcontrols/" class="dropdown-item">Global Controls</a>
</li>
                                    
<li>
    <a href="../../userguide/multifile/" class="dropdown-item">Reading images from multiple files</a>
</li>
                                    
<li>
    <a href="../../userguide/expr/" class="dropdown-item">The "expr" node for mathematical expressions</a>
</li>
                                    
<li>
    <a href="../../userguide/batch/" class="dropdown-item">Batch mode</a>
</li>
                                    
<li>
    <a href="../../autodocs/" class="dropdown-item">Autodocs</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Developer's Guide <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../" class="dropdown-item">Overview</a>
</li>
                                    
<li>
    <a href="../library/" class="dropdown-item">Using PCOT as a library</a>
</li>
                                    
<li>
    <a href="../plugins/" class="dropdown-item">Writing PCOT plugins</a>
</li>
                                    
<li>
    <a href="../nodeser/" class="dropdown-item">Node serialisation</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../../roadmap/" class="nav-link">Roadmap</a>
                            </li>
                            <li class="navitem">
                                <a href="../../gettingstarted/issues/" class="nav-link">Known issues</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container ">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#notes-on-types" class="nav-link">Notes on types</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#an-example" class="nav-link">An example</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#operators" class="nav-link">Operators</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#adding-a-new-type-with-operator-semantics" class="nav-link">Adding a new type with operator semantics</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="notes-on-types">Notes on types</h1>
<p>Built-in types of data (i.e. of Datum objects) are kept in <strong>datum.py</strong>.</p>
<p>A type specifies:</p>
<ul>
<li>its name</li>
<li>whether it is an image subtype (it's tricky to write a method for this,
since ImgType is defined after Type)</li>
<li>whether it is an "internal type" used in the expression evaluator and not for connections
(e.g. IdentType, FuncType and NoneType)</li>
<li>optional serialisation and deserialisation methods taking and returning Datum, which convert to and from JSON-serialisable
values - i.e. primitive types, tuples, lists and dicts; no objects.</li>
</ul>
<p>The Datum class has a type list, which contains singletons of all the type
objects. To register a type:</p>
<ul>
<li>create a type object</li>
<li>append to the Datum types list</li>
<li>if required, register a connector brush with connbrushes.register.</li>
<li>Deal with binary and unary operators in <em>expr</em> expressions if required (see below).</li>
</ul>
<h2 id="an-example">An example</h2>
<p>This code is taken from the <strong>example1.py</strong> plugin file. This (in part) declares a
function which takes two numbers, and produces an object containing the dividend and
remainder of those numbers. These are held in a custom object:</p>
<pre><code># Our data will be an object of class TestObject.

class TestObject:
    def __init__(self, div, rem):
        self.div = div
        self.rem = rem

    def __str__(self):
        return f&quot;({self.div}, {self.rem})&quot;
</code></pre>
<p>Now we need to provide the type singleton:</p>
<pre><code># now the type singleton, which controls how Datum objects which hold TestObjects
# serialise and deserialise themselves (turn themselves into JSON-serialisable
# data and back).

# I'm naming the class with an underscore - the type object will be without this.
class _TestObjectType(Type):
    def __init__(self):
        # just call the superconstructor telling it the name of the type
        # and in this case, that the stringification (the result of __str__ on the
        # value) is short enough to fit into an expr node's graph box.
        super().__init__('testtuple', outputStringShort=True)

    # now we have to write code which converts Datums of this type into
    # stuff which can be converted to JSON and back again. Converting
    # into JSON-serialisable is termed &quot;serialisation&quot; and reconstructing
    # the original Datum object and all its data is &quot;deserialisation&quot;.

    def serialise(self, d):
        # how to serialise data of this type: serialise() methods must return
        # a tuple of typename and contents.
        # The contents must be JSON-serialisable, and must contain both the
        # data to be saved and the serialised source information.

        # First convert TestObject to something we can serialise
        serialisedObject = d.val.div, d.val.rem
        # and create the serialised datum of the name and contents
        return self.name, (serialisedObject, d.getSources().serialise())

    def deserialise(self, d, document):
        # given a serialised tuple generated by serialise(), produce a Datum
        # of this type.
        serialisedObject, serialisedSources = d        # first generate the contents
        # deserialise the serialised sources data
        sources = SourceSet.deserialise(serialisedSources, document)
        # then pass to the datum constructor along with the type singleton.
        return Datum(self, serialisedObject, sources) 
</code></pre>
<p>We register the type singleton, but keep a reference to the object so we can use
it in our own code when we create Datum objects. We also provide a connector
brush, so that connections of this type are rendered differently in the graph:</p>
<pre><code># create the singleton and register it, but keep hold of the variable so
# we can use it to create new Datum objects.
TestObjectType = _TestObjectType()
Datum.registerType(TestObjectType)

# add a brush for the connections in the graph
pcot.connbrushes.register(TestObjectType, QColor(&quot;darkMagenta&quot;))
</code></pre>
<p>See <strong>example1.py</strong> for how this new type is used.</p>
<h2 id="operators">Operators</h2>
<div class="alert alert-info" role="alert">
<p>Work in progress - read <a href="../values/">the Value documentation</a> to see
how this works in detail, particularly with numeric and image data
(i.e. data which can be expressed as (mean,sd,DQ) triples).</p>
</div>
<p>Previously operators were entirely hardwired in utils.ops. This stopped us
creating new types. We could define something like binop(self,other) in
the type classes, but this wouldn't allow us to add new types as the RHS
for operations which have built-in types as the LHS.</p>
<p>The Simplest Thing That Can Possibly Work is a dictionary of operation functions
keyed (in the case of binops) by a tuple of types.</p>
<p>So this is how operators work now, relying on two registration processes.</p>
<p>The first is the registration of the operator lexeme (e.g. "*" or "+")
and precedence, and an associated function to call. This happens
as part of Parser. The function calls a binop() function in the ops
module, passing in the operator ID.</p>
<p>The second is the registration of operator ID (e.g. Operator.ADD)
and types in the ops module, with an associated function to call. This
is often a wrapper function around a lambda: the wrapper knows to
unpack (say) image and number data, and the lambda says they should
be processed with addition.</p>
<h2 id="adding-a-new-type-with-operator-semantics">Adding a new type with operator semantics</h2>
<ul>
<li>Create a subclass of datum.Type</li>
<li>add serialisation methods if required</li>
<li>call Datum.registerType() with the type</li>
<li>If required, add a new connector brush with connbrushes.register()</li>
<li>To use the type, use the Type object with the Datum constructor and
Datum.get() method.</li>
</ul>
<p>Adding operator semantics</p>
<ul>
<li>call ops.registerBinop and ops.registerUnop to register functions
to perform the required operations. The function should take Datum
objects and return a Datum.</li>
</ul></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
