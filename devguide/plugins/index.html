<!DOCTYPE html>
<html lang="en">
    <head>
    
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="robots" content="noindex,nofollow">

        <title>Writing PCOT plugins - PCOT Documentation</title>
    
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">
    <link rel="stylesheet" href="../../css/lightbox.min.css">
    <link rel="stylesheet" href="../../css/site.css">

    

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
    <script src="../../js/lightbox-plus-jquery.min.js"></script>
 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">PCOT Documentation</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Getting Started <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../gettingstarted/" class="dropdown-item">Overview</a>
</li>
                                    
<li>
    <a href="../../gettingstarted/installrun/" class="dropdown-item">Installing and running</a>
</li>
                                    
<li>
    <a href="../../gettingstarted/concepts/" class="dropdown-item">PCOT concepts</a>
</li>
                                    
<li>
    <a href="../../gettingstarted/tutorial/" class="dropdown-item">Tutorial</a>
</li>
                                    
<li>
    <a href="../../gettingstarted/inputs/" class="dropdown-item">Loading other image formats</a>
</li>
                                    
<li>
    <a href="../../gettingstarted/help/" class="dropdown-item">Getting help</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">User Guide <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../userguide/" class="dropdown-item">Overview</a>
</li>
                                    
<li>
    <a href="../../userguide/principles/" class="dropdown-item">Operating principles</a>
</li>
                                    
<li>
    <a href="../../userguide/canvas/" class="dropdown-item">The Canvas</a>
</li>
                                    
<li>
    <a href="../../userguide/globalcontrols/" class="dropdown-item">Global Controls</a>
</li>
                                    
<li>
    <a href="../../userguide/multifile/" class="dropdown-item">Reading images from multiple files</a>
</li>
                                    
<li>
    <a href="../../userguide/expr/" class="dropdown-item">The "expr" node for mathematical expressions</a>
</li>
                                    
<li>
    <a href="../../autodocs/" class="dropdown-item">Autodocs</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Developer's Guide <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../" class="dropdown-item">Overview</a>
</li>
                                    
<li>
    <a href="../library/" class="dropdown-item">Using PCOT as a library</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">Writing PCOT plugins</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../../roadmap/" class="nav-link">Roadmap</a>
                            </li>
                            <li class="navitem">
                                <a href="../../gettingstarted/issues/" class="nav-link">Known issues</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../library/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../../roadmap/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#writing-pcot-plugins" class="nav-link">Writing PCOT plugins</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#the-plugin-path" class="nav-link">The plugin path</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#adding-new-types" class="nav-link">Adding new types</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#adding-new-datum-functions-for-use-in-expr-and-python-code" class="nav-link">Adding new Datum functions (for use in expr and Python code)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#adding-new-menu-items" class="nav-link">Adding new menu items</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#adding-new-node-types" class="nav-link">Adding new node types</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="writing-pcot-plugins">Writing PCOT plugins</h1>
<h2 id="the-plugin-path">The plugin path</h2>
<p>PCOT can be extended by adding Python scripts to a directory in the plugin
path. By default this is just <code>pcotplugins</code> in the user's home directory,
but it can be changed by editing the <code>.pcot.ini</code> file in that directory
and modifying the <code>pluginpath</code> value in the <code>Locations</code> section.
This should be a semicolon-separated list of directories.</p>
<div class="alert alert-warning" role="alert">
<p>You may be tempted to use quotes in the names of you plugin directories:
don't. It should work fine, even if your directories have spaces in them.
For example, use <code>~/blah/RIM Dewarping</code> and not 
<code>~/blah/"RIM Dewarping"</code></p>
</div>
<h2 id="adding-new-types">Adding new types</h2>
<p>This is covered in <a href="../types/">a separate document</a>, as it's not often done
and is a little involved.</p>
<h2 id="adding-new-datum-functions-for-use-in-expr-and-python-code">Adding new Datum functions (for use in <em>expr</em> and Python code)</h2>
<p>The functions used in the <em>expr</em> expression node can also be used in
Python programs which use PCOT as a library (this is 
<a href="../library/">covered here</a>). These are called Datum functions because
they both take and return Datum objects.</p>
<p>To create a Datum function:</p>
<ul>
<li>use the <code>@datumfunc</code> decorator. This will
register the function and wrap it in two separate wrappers: one for use
in <em>expr</em>, the other for use in Python.</li>
<li>write a docstring in the correct format, as illustrated below.</li>
</ul>
<p>Here's an example which declares a function to take two numbers
a,b and calculate a+b*2. Note that as
in all PCOT code we have to make sure the sources are handled correctly.</p>
<pre><code class="language-python">@datumfunc
def example_func(a, b):
    &quot;&quot;&quot;
    Example function that takes two numbers a,b and returns a+b*2
    @param a: number: first number
    @param b: number: second number
    &quot;&quot;&quot;
    return a + b * Datum.k(2)
</code></pre>
<p>This is a trivial example that relies on Datum objects having operator
overloads, but note that we need to multiply b by a Datum, not a number.
To do this we use <code>Datum.k</code> to create a scalar constant.</p>
<h3 id="the-docstring">The docstring</h3>
<p>This should consist of a number of lines describing the function followed
by a number of <code>@param</code> lines, one for each parameter. These contain
the following, separated by colons:</p>
<ul>
<li>The string `@param'</li>
<li>A Datum type name - these can be found in the constructors of datum type
objects in <code>datumtypes.py</code>, but the most common are <code>number</code>, <code>img</code>, <code>roi</code>,
<code>string</code>.</li>
<li>A description of the parameter</li>
</ul>
<h3 id="optional-numericstring-arguments">Optional numeric/string arguments</h3>
<p>Optional arguments with defaults can be provided, but only if they
are numeric or strings (because these are the only types which make
sense for the default values). In this case the defaults will be
converted to Datum objects if they are used.</p>
<p>Here is an example of a function which
multiplies an image by a constant, with the default being 2:</p>
<pre><code>@datumfunc
def example_func(img, k=2):
    &quot;&quot;&quot;
    Example function that takes two numbers a,b and returns a+b*2
    @param img:img:the image
    @param k:number:the multiplier
    &quot;&quot;&quot;
    # no need to construct a Datum with Datum.k(), because k is already
    # a Datum.
    return img * k
</code></pre>
<p>Here's another example which adds two numbers or multiplies them,
depending on a string - and the default is to add:</p>
<pre><code>@datumfunc
def stringexample(a, b, op='add'):
    &quot;&quot;&quot;
    String argument example
    @param a: number: first number
    @param b: number: second number
    @param op: string: operation to perform
    &quot;&quot;&quot;
    if op.get(Datum.STRING) == 'add':
        return a + b
    elif op.get(Datum.STRING) == 'sub':
        return a - b
    else:
        raise ValueError(&quot;Unknown operation&quot;)
</code></pre>
<p>Note that you usually have to extract the actual value from the Datum
objects, as we do with the <code>op</code> argument above. In previous examples,
we take advantage of Datum's extensive operator overloading.</p>
<h3 id="variadic-arguments">Variadic arguments</h3>
<p>For a variable number of arguments, use the <code>*args</code> keyword. Here, you have
to check the types by hand. For example, this function will sum numbers:</p>
<pre><code>@datumfunc
def sumall(*args):
    &quot;&quot;&quot;
    Sum all arguments
    &quot;&quot;&quot;
    s = sum([x.get(Datum.NUMBER).n for x in args])
    return Datum(Datum.NUMBER, Value(s, 0, NOUNCERTAINTY), nullSourceSet)
</code></pre>
<p>Note the use of <code>Value</code> here to construct a scalar value with
standard deviation (zero here) and DQ bits (indicating no uncertainty data).
Also note the mandatory use of a source set - just the <code>nullSourceSet</code>
here to indicate there is no source; this is just a test function. In a real
function we would combine the input sources.</p>
<p>For more examples of functions, look at the <code>ExpressionEvaluator</code>
constructor in the <code>pcot.expressions.eval</code> module.</p>
<h2 id="adding-new-menu-items">Adding new menu items</h2>
<p>This is done by adding a function to a list of functions called when a
a main window is opened. Writing code here will require some knowledge of Qt.
Here is a menu option added to the File menu which will look for 
selected node in the document's graph, fetch its first output, and
save it as an ENVI file (assuming it is an image - error checking
is left as an exercise for the reader).</p>
<pre><code class="language-python">import pcot
import os
from PySide2 import QtWidgets
from PySide2.QtWidgets import QAction, QMessageBox
from pcot.dataformats import envi

def saveEnvi(w):
    &quot;&quot;&quot;Function takes a PCOT main window. It finds the first selected
    node, gets its output 0, and then saves an ENVI from that image.&quot;&quot;&quot;

    sel = w.doc.getSelection()
    if len(sel) == 0:
        ui.log(&quot;no selected node&quot;)
        return
    node = sel[0]

    directory = os.path.expanduser(pcot.config.getDefaultDir('pcotfiles'))
    res = QtWidgets.QFileDialog.getSaveFileName(w,
                                                &quot;ENVI file &quot;,
                                                os.path.expanduser(pcot.config.getDefaultDir('pcotfiles')),
                                                &quot;ENVI files (*.hdr)&quot;)
    if res[0] != '':
        # get the output of that node
        (root, ext) = os.path.splitext(res[0])
        img = node.getOutput(0, pcot.datum.Datum.IMG)
        envi.write(root, img)


# the function to add the new menu item. This will take a single parameter:
# the window to which the menu should be added.

def addMenus(w):
    &quot;&quot;&quot;Add an item to the Edit menu&quot;&quot;&quot;

    # create the menu action (i.e. the item)
    act = QAction(&quot;save to ENVI&quot;,parent=w)

    # find (or create) the Edit menu and add the action to it
    w.findOrAddMenu(&quot;Edit&quot;).addAction(act)

    # link the action to the saveEnvi function, using a closure to
    # make sure the window argument is passed into that function.
    act.triggered.connect(lambda: saveEnvi(w))


# Add the addMenus functions to the list of functions called as the
# main window opens.

pcot.config.addMainWindowHook(addMenus)
</code></pre>
<h2 id="adding-new-node-types">Adding new node types</h2>
<p>Node types are represented by singletons of subclasses of <code>XFormType</code>
(Nodes themselves are of type <code>XForm</code>, which stands for <em>transform</em> for
historical reasons). Developing new <code>XFormType</code> subclasses is largely
beyond the scope of this document, but you can learn a lot from looking at the
<code>pcot.xforms</code> package and the modules therein.</p>
<p>To create a new node type, declare a new subclass of <code>XFormType</code> and decorate
it with the <code>@xformtype</code> decorator. This will make the type autoregister:
the singleton will be constructed and added to the internal type registry.</p>
<p>You will need to write the following methods in your subclass:</p>
<ul>
<li><strong>__init__(self)</strong> to construct the type object (NOT the individual nodes).
This will call the superconstructor to set the type's name, group (for the
palette), and version. It will add the input and output connectors.</li>
<li><strong>init(self, node)</strong> will initialise any private data in the node itself
(which is an <code>XForm</code>). Don't confuse this with <code>__init__</code>!</li>
<li><strong>createTab(self, node, window)</strong> will create a new node area (i.e. tab).
Often, this can be a <code>TabData</code> which will look at the node's <code>out</code>
attribute, which should be a <code>Datum.</code></li>
<li><strong>perform(self, node)</strong> will actually perform the node's action, reading inputs 
and setting outputs.</li>
</ul>
<p>Remember: there is only one <code>XFormType</code> object for each node type. All
nodes are of type <code>XForm</code>, and they link to an <code>XFormType</code> object to
tell them how to behave. This might seem a really odd way to do things, but it
follows "favour composition over inheritance" and saves messiness elsewhere.</p>
<p>Here is an example which does edge detection with OpenCV:</p>
<pre><code>import cv2 as cv
import numpy as np

from pcot.sources import SourceSet
from pcot.xform import XFormType, xformtype, Datum
from pcot.xforms.tabdata import TabData
from pcot.imagecube import ImageCube

import pcot.config


# The first part of the plugin creates a new type of node.

# this decorator will cause the node to auto-register.

@xformtype
class XFormEdgeDetect(XFormType):
    &quot;&quot;&quot;This is an edge detector node. It takes an image and performs Canny edge detection, currently with
    fixed thresholds. It does not take account of ROIs, since this would be pointless when we're converting
    from a potentially multispectral image to greyscale (well, boolean).
    Exercise for the reader - add variable thresholds, either as numeric inputs or as
    numeric parameters settable from the node tab.&quot;&quot;&quot;

    def __init__(self):
        # this node should appear in the maths group.
        super().__init__(&quot;edge&quot;, &quot;maths&quot;, &quot;0.0.0&quot;)
        # set input and output - they are images and are unnamed.
        self.addInputConnector(&quot;&quot;, Datum.IMG)
        self.addOutputConnector(&quot;&quot;, Datum.IMG)

    def createTab(self, n, w):
        # there is no custom tab, we just use a data canvas. This expects &quot;node.out&quot; to be set to
        # either None or a Datum.
        return TabData(n, w)

    def init(self, n):
        # No initialisation required.
        pass

    def perform(self, node):
        # get the input image
        img = node.getInput(0, Datum.IMG)
        if img is not None:
            # find mean of all channels - construct a transform array and then use it.
            mat = np.array([1 / img.channels] * img.channels).reshape((1, img.channels))
            grey = cv.transform(img.img, mat)
            # convert to 8-bit integer from 32-bit float
            img8 = (grey * 255).astype('uint8')
            # Perform edge detection
            out = cv.Canny(img8, 100, 200)
            # Convert back to 32-bit float
            out = (out / 255).astype('float32')
            # create the imagecube and set node.out for the canvas in the tab
            img = ImageCube(out, None, img.sources)
            node.out = Datum(Datum.IMG, img)
        else:
            # no image on the input, set node.out to None
            node.out = Datum.null
        # output node.out
        node.setOutput(0, node.out)
</code></pre>
<h3 id="writing-custom-tabs">Writing custom Tabs</h3>
<p>As noted above, a new <code>XFormType</code> subclass (i.e. a new node type)
can often just use <code>TabData</code>, which will display the Datum stored on
its first output (output 0). Sometimes, however, a custom tab needs to be
written. This can be a complex task, but an example is given in
<code>xformexample.py</code> in the <code>xforms</code> package. All the standard XFormTypes
are in this package, so you can also look at them. </p>
<p>The basic idea is:</p>
<ul>
<li>Create a subclass of <code>pcot.ui.tabs.Tab</code></li>
<li>Write the constructor to call the superclass constructor and create the UI
(or load a Designer-created UI by passing an argument to the superclass.
constructor), and call <code>self.nodeChanged()</code> at the end to refresh the tab from the node.</li>
<li>Override <code>onNodeChanged()</code> to update the tab from the node.</li>
<li>Use the Qt signal/slot mechanism to connect the tab's controls to methods in the tab class
and write code to update the node from the tab in these methods, calling
<code>self.changed()</code> at the end of each method.</li>
</ul>
<p>The tab will have a <code>node</code> field which addresses the node it is viewing (but see
<a href="#undo-and-references-to-data-in-nodes">below</a> for a "gotcha" - the value of this field
will change after an undo operation!)</p>
<h3 id="using-canvas-in-custom-tabs">Using Canvas in custom tabs</h3>
<p>Creating a Canvas programmatically is straightforward, and there is an example of this
in <code>xformexample.py</code>. 
If you are creating a tab in Designer, you need to add a canvas as a QWidget which you then "promote"
to a custom control (the canvas). In the promote dialog, the class should be <code>Canvas</code> and the
header file <code>pcot.ui.canvas</code> (i.e. the package name). </p>
<p>In your <code>onNodeChanged()</code> method you
will need to update the canvas. This involves doing a little setup, then getting the 
image we want to display - usually the output - and telling the canvas to display it:</p>
<pre><code>    # do some setup
    self.canvas.setNode(self.node)

    # then display the image
    img = self.node.getOutput(0, Datum.IMG)
    self.canvas.display(img)
</code></pre>
<p>The setup synchronises the canvas with the node, telling the canvas about the RGB mappings
and that it should store data in the node for serialisation. We have to set that up each
time because of how undo works, which is discussed in the next section.</p>
<h3 id="undo-and-references-to-data-in-nodes">Undo and references to data in nodes</h3>
<p>This is a major "gotcha." Whenever an undo occurs, the old node is discarded and a new node
created from a previously archived version in memory. This means that the <code>node</code> field changes.
Because of this, your tab <strong>must not</strong> store references to objects inside the node, because after
an undo those references will be stale. Instead, always use <code>self.node...</code> to access data.</p>
<p>It is OK to use the tab to store UI-only data which is not persisted (saved to a file or to the
undo mechanism).</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
